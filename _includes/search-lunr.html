<script src="/assets/js/lunr.js"></script>

<!-- Search form -->
<form
  class="bd-search"
  style="margin: 1rem 0;"
  onsubmit="return lunr_search(document.getElementById('lunrsearch').value);"
>
  <input
    type="text"
    class="form-control text-small"
    id="lunrsearch"
    name="q"
    value=""
    placeholder="Loading search index..."
    disabled
  />
</form>

<div id="lunrsearchresults" style="display:none;"></div>

<script>
  let idx = null;
  let documents = [];

  // Load search.json and build Lunr index
  fetch("/search.json")
    .then((response) => response.json())
    .then((data) => {
      documents = data;

      idx = lunr(function () {
        this.ref("id");
        this.field("title");
        this.field("body");

        documents.forEach((doc) => this.add(doc));
      });

      // Enable search input after index loads
      const searchInput = document.getElementById("lunrsearch");
      searchInput.disabled = false;
      searchInput.placeholder = "খুঁজুন...";
    })
    .catch((error) => {
      console.error("Search index load failed:", error);
      const searchInput = document.getElementById("lunrsearch");
      searchInput.placeholder = "Search index failed to load";
    });

  // Search function
  function lunr_search(term) {
    term = term.trim();
    if (!idx) {
      alert("Search index is still loading. Please wait a moment.");
      return false;
    }
    if (!term) {
      alert("Please enter a search term.");
      return false;
    }

    const resultsContainer = document.getElementById("lunrsearchresults");
    resultsContainer.style.display = "block";
    document.body.classList.add("modal-open");

    resultsContainer.innerHTML = `
      <div id="resultsmodal" class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog shadow-lg" role="document">
          <div class="modal-content">
            <div class="modal-header" id="modtit">
              <h5 class="modal-title">Search results for '${term}'</h5>
              <button type="button" class="close" id="btnx" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body"><ul class="mb-0"></ul></div>
            <div class="modal-footer">
              <button id="btnxFooter" type="button" class="btn btn-secondary btn-sm">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;

    const resultsList = resultsContainer.querySelector("ul");
    resultsList.innerHTML = "";

    const results = idx.search(term);

    if (results.length > 0) {
      results.forEach(({ ref }) => {
        const doc = documents.find((d) => d.id == ref);
        if (!doc) return;

        const html = `
          <li class="lunrsearchresult">
            <a href="${doc.url}">
              <span class="title">${doc.title}</span><br />
              <small>
                <span class="body">${doc.body.substring(0, 160)}...</span><br />
                <span class="url">${doc.url}</span>
              </small>
            </a>
          </li>`;
        resultsList.insertAdjacentHTML("beforeend", html);
      });
    } else {
      resultsList.innerHTML =
        '<li class="lunrsearchresult">Sorry, no results found. Try a different search!</li>';
    }

    // Close modal handlers
    function closeModal() {
      resultsContainer.style.display = "none";
      document.body.classList.remove("modal-open");
    }

    resultsContainer.querySelector("#btnx").onclick = closeModal;
    resultsContainer.querySelector("#btnxFooter").onclick = closeModal;

    return false; // prevent form submission
  }
</script>

<style>
  .lunrsearchresult .title {
    color: #d9230f;
  }
  .lunrsearchresult .url {
    color: silver;
  }
  .lunrsearchresult a {
    display: block;
    color: #777;
  }
  .lunrsearchresult a:hover,
  .lunrsearchresult a:focus {
    text-decoration: none;
  }
  .lunrsearchresult a:hover .title {
    text-decoration: underline;
  }
  /* Optional: simple modal open body fix */
  body.modal-open {
    overflow: hidden;
  }
</style>
